<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Drawing</title>
    <style>
        canvas {
            border: 1px solid black;
        }
        button.color-button {
            display:inline-block;margin:1px;width:20px;height:20px;
        }
    </style>
    <script src="socket.io/socket.io.js"></script>
</head>
<body>
    <div>
        <button id="red" class="color-button" style="background-color:red;">&nbsp;</button>
        <button id="green" class="color-button" style="background-color:green;">&nbsp;</button>
        <button id="blue" class="color-button" style="background-color:blue;">&nbsp;</button>
        <button id="black" class="color-button" style="background-color:black;">&nbsp;</button>
        <button id="white" class="color-button" style="background-color:white;">&nbsp;</button>
    </div>
    <canvas id="canvas" width="128" height="128" style="width:128px;height:128px;"></canvas>
    <div>
        <button id="clear-white" class="color-button" style="background-color:white;color:black;">X</button>
        <button id="clear-black" class="color-button" style="background-color:black;color:white;">X</button>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const socket = io({ path: 'socket.io' });
        let currentColor = '#000000';

        /* set the drawing color */
        function setColor(color) {
            currentColor = color;
            context.fillStyle = color;
        }

        document.getElementById('red').addEventListener('click', () => setColor('#f90000'));
        document.getElementById('green').addEventListener('click', () => setColor('##00f900'));
        document.getElementById('blue').addEventListener('click', () => setColor('#0000f9'));
        document.getElementById('black').addEventListener('click', () => setColor('#000000'));
        document.getElementById('white').addEventListener('click', () => setColor('#ffffff'));

        /* set the clear colors */
        function clearCanvas(clearColor) {
            for(var i=0;i<128;i++){ for(var j=0;j<=128;j++) {
                socket.emit('draw', { x: i, y: j , color: clearColor});
            }};
        }

        document.getElementById('clear-white').addEventListener('click', () => clearCanvas('#ffffff'));
        document.getElementById('clear-black').addEventListener('click', () => clearCanvas('#000000'));

        // Load existing drawing from the server
        socket.on('loadDrawing', (pixels) => {
            pixels.forEach(pixel => {
                context.fillStyle = pixel.color;
                context.fillRect(pixel.x, pixel.y, 1, 1);
            });
        });

        canvas.addEventListener('mousedown', (e) => {
            const draw = (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                context.fillRect(x-3, y-3, 7, 7);

                for(var i=-3;i<=3;i++){ for(var j=-3;j<=3;j++) {
                // Emit the draw event to the server
                    if (x+i < 0 || y+j < 0) {
                        continue;
                    }
                    socket.emit('draw', { x: x+i, y: y+j , color: currentColor });
                }}
            };

            draw(e);
            canvas.addEventListener('mousemove', draw);

            document.addEventListener('mouseup', () => {
                canvas.removeEventListener('mousemove', draw);
            }, { once: true });
        });

        // Listen for draw events from other clients
        socket.on('draw', (data) => {
            context.fillStyle = data.color;
            context.fillRect(data.x, data.y, 1, 1);
        });
    </script>
</body>
</html>