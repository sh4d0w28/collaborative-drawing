<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="socket.io/socket.io.js"></script>
    <style>
        html,body{margin:0;padding:0}
    </style>
</head>
<body>
    <canvas id="canvas" width="128" height="128" style="border: solid 1px black;"></canvas>
    <div id="btns"></div>
    <script>
        const dimX=128;
        const dimY=128;
        const colors = {0: '#000000', 1: '#005500',  2: '#00aa00',  3: '#00ff00', 
                        4: '#0000ff', 5: '#0055ff',  6: '#00aaff',  7: '#00ffff',
                        8: '#ff0000', 9: '#ff5500', 10: '#ffaa00', 11: '#ffff00', 
                       12: '#ff00ff', 13: '#ff55ff', 14: '#ffaaff', 15: '#ffffff'
        }
        var colorInd = 0;

        /* generate buttons */
        var btns = document.getElementById("btns");
        Object.entries(colors).forEach((color) => {
            var button = document.createElement('button');
            button.setAttribute('data-id', color[0])
            // button.innerText = color[0];
            button.style.backgroundColor = color[1];
            button.addEventListener('click', function() {
                colorInd = this.dataset['id'];
                context.fillStyle = colors[colorInd];
            });
            btns.appendChild(button);
        });
        
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const socket = io();

        // Load existing drawing from the server
        socket.on('loadDrawing', (data) => {
            var imageData = new ImageData(new Uint8ClampedArray(data),dimX,dimY)
            console.log(imageData);
            context.putImageData(imageData, 0, 0)
        });


        socket.on('draw', (data) => {
            var fs = context.fillStyle;
            context.fillStyle = colors[data.color];
            context.fillRect(data.x, data.y, 1, 1);
            context.fillStyle = fs;
        })

        canvas.addEventListener('mousedown', (e) => {
            const draw = (e) => {
                const x = e.offsetX;
                const y = e.offsetY;
                /* simple check for mousemove outside */
                if (x<0 || y<0) { return; }
                if (x>=dimX || y>=dimY) { return; }

                /* draw */
                context.fillRect(x, y, 1, 1);

                /* send bit to server */
                socket.emit('draw', {bit: '#'+(x+y*dimY), color: colorInd, x:x, y:y });
            };
            draw(e);
            canvas.addEventListener('mousemove', draw);
            document.addEventListener('mouseup', () => {
                canvas.removeEventListener('mousemove', draw);
            }, { once: true });
        });
    </script>
</body>
</html>