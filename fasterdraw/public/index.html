<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script src="socket.io/socket.io.js"></script>
    <style>
        html,body{margin:0;padding:0}
    </style>
</head>
<body>
    <canvas id="canvas" width="128" height="128" style="border: solid 1px black;"></canvas>
    <div id="btns"></div>
    <select id="size" onchange="setBrush(this);" onfocus="this.selectedIndex = -1;">
        <option value="1" selected="selected">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>
    <script>
        const dimX=128;
        const dimY=128;
        const colors = {0: '#000000', 1: '#005500',  2: '#00aa00',  3: '#00ff00', 
                        4: '#0000ff', 5: '#0055ff',  6: '#00aaff',  7: '#00ffff',
                        8: '#ff0000', 9: '#ff5500', 10: '#ffaa00', 11: '#ffff00', 
                       12: '#ff00ff', 13: '#ff55ff', 14: '#ffaaff', 15: '#ffffff'
        }
        var colorInd = 0;
        var brushSize = 1;

        function setBrush(sender) {
            brushSize = sender.value;
        }

        /* generate buttons */
        var btns = document.getElementById("btns");
        Object.entries(colors).forEach((color, i) => {
            var button = document.createElement('button');
            button.setAttribute('data-id', color[0])
            button.style.backgroundColor = color[1];
            button.style.width = "15px"
            button.style.height = "15px"
            button.style.display = "inline-block";

            button.addEventListener('click', function() {
                colorInd = this.dataset['id'];
                context.fillStyle = colors[colorInd];
            });
            btns.appendChild(button);
            if(i % 4 == 3) { 
                btns.append(document.createElement("br"))
            }
        });
        
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const socket = io();

        // Load existing drawing from the server
        socket.on('loadDrawing', (data) => {
            var imageData = new ImageData(new Uint8ClampedArray(data),dimX,dimY)
            console.log(imageData);
            context.putImageData(imageData, 0, 0)
        });

        socket.on('draw', (data) => {
            data.forEach((bitspec) => {
                var fs = context.fillStyle;
                context.fillStyle = colors[data.color];
                context.fillRect(data.x, data.y, 1, 1);
                context.fillStyle = fs;            
            });
        })

        function drawBrush(context, x,y, size) {
            var rx = x-size;
            var ry = y-size;
            /* draw */
            context.fillRect(rx,ry,size*2+1,size*2+1);
            var bits = []
            for(var i = Math.max(x-size, 0); i <= Math.min(x+size, dimX-1); i++) {
                for(var j = Math.max(y-size,0); j<=Math.min(j+size, dimY-1); j++) {
                    bits.push({bit: '#'+(i+dimY*j), color: colorInd, x:i, y:j})
                }
            }
            /* send bit to server */
            socket.emit('draw', bits);
        }

        canvas.addEventListener('mousedown', (e) => {
            const draw = (e) => {
                const x = e.offsetX;
                const y = e.offsetY;
                /* simple check for mousemove outside */
                if (x<0 || y<0) { return; }
                if (x>=dimX || y>=dimY) { return; }

                drawBrush(context, x, y, brushSize);
            };
            draw(e);
            canvas.addEventListener('mousemove', draw);
            document.addEventListener('mouseup', () => {
                canvas.removeEventListener('mousemove', draw);
            }, { once: true });
        });
    </script>
</body>
</html>